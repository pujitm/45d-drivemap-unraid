#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)
TEMPLATE="${ROOT_DIR}/45d-drivemap.plg.template"
OUT="${ROOT_DIR}/45d-drivemap.plg"
CHANGELOG="${ROOT_DIR}/CHANGELOG.md"

VERSION="${1:-$(awk -F= '/^version=/{print $2}' "${ROOT_DIR}/plugin.cfg")}"
SHA256="${2:-}"
REPO="${3:-pujitm/45d-drivemap-unraid}"

if [[ ! -f "${TEMPLATE}" ]]; then
  echo "Template not found: ${TEMPLATE}" >&2
  exit 1
fi
if [[ ! -f "${CHANGELOG}" ]]; then
  echo "Changelog not found: ${CHANGELOG}" >&2
  exit 1
fi

if [[ -z "${SHA256}" ]]; then
  PACKAGE="${ROOT_DIR}/packages/45d-drivemap-${VERSION}.txz"
  if [[ ! -f "${PACKAGE}" ]]; then
    echo "Package not found for checksum: ${PACKAGE}" >&2
    exit 1
  fi
  SHA256=$(shasum -a 256 "${PACKAGE}" | awk '{print $1}')
fi

PLUGIN_URL="https://github.com/${REPO}/releases/latest/download/45d-drivemap.plg"
PACKAGE_URL_BASE="https://github.com/${REPO}/releases/download/v${VERSION}"
CHANGES_BLOCK="$(
  awk '
      {
        line = $0
        sub(/\r$/, "", line)
        if (line ~ /^#[[:space:]]+Changelog/) next
        if (line ~ /^[[:space:]]*$/) next
        if (line ~ /^##[[:space:]]+/) {
          sub(/^##[[:space:]]+/, "", line)
          print "- " line ":"
          next
        }
        if (line ~ /^###[[:space:]]+/) {
          sub(/^###[[:space:]]+/, "", line)
          print "  - " line ":"
          next
        }
        if (line ~ /^- /) {
          print "  " line
          next
        }
        if (line ~ /^\* /) {
          sub(/^\*/, "-", line)
          print "  " line
          next
        }
        print "  - " line
      }
    ' "${CHANGELOG}" \
  | sed \
      -e "s/&/\\&amp;/g" \
      -e "s/</\\&lt;/g" \
      -e "s/>/\\&gt;/g" \
      -e "s/^/    /"
)"

if [[ -z "${CHANGES_BLOCK}" ]]; then
  echo "Changelog has no renderable entries: ${CHANGELOG}" >&2
  exit 1
fi

TMP_OUT=$(mktemp)
trap 'rm -f "${TMP_OUT}"' EXIT

sed \
  -e "s|__VERSION__|${VERSION}|g" \
  -e "s|__PACKAGE_SHA256__|${SHA256}|g" \
  -e "s|__PLUGIN_URL__|${PLUGIN_URL}|g" \
  -e "s|__PACKAGE_URL_BASE__|${PACKAGE_URL_BASE}|g" \
  "${TEMPLATE}" > "${TMP_OUT}"

CHANGES_BLOCK="${CHANGES_BLOCK}" perl -0pe 's/__CHANGES__/$ENV{CHANGES_BLOCK}/g' "${TMP_OUT}" > "${OUT}"

echo "${OUT}"
